/**
 * Agricultural Alerts System
 * Fetches and displays agricultural alerts for landowners
 *
 * This file uses an approach to prevent duplicate declarations when included in multiple pages:
 * 1. It checks if global variables/functions already exist before declaring them
 * 2. All functions are attached to the window object to make them globally accessible
 * 3. The entire file is wrapped in an IIFE to avoid polluting the global namespace
 * 4. Initialization only happens once through the agricAlertsInitialized flag
 */

// Lebanese cities for the location dropdown
// Check if lebaneseCities already exists globally before declaring it
if (typeof window.lebaneseCities === "undefined") {
  window.lebaneseCities = [
    "Beirut",
    "Tripoli",
    "Sidon",
    "Tyre",
    "Nabatieh",
    "Jounieh",
    "Zahle",
    "Baalbek",
    "Byblos",
    "Aley",
    "Batroun",
    "Bcharre",
    "Halba",
    "Jbeil",
    "Jezzine",
    "Joub Jannine",
    "Marjayoun",
    "Minieh",
    "Zgharta",
  ];
}

// Wrap all functions in an IIFE (Immediately Invoked Function Expression)
// to prevent global namespace pollution and redeclaration issues
(function () {
  // Only define these functions if they don't already exist
  if (typeof window.fetchAgriculturalAlerts !== "function") {
    // Main function to fetch agricultural alerts
    window.fetchAgriculturalAlerts = async function (city = null) {
      try {
        let url = "/api/agriculture-alerts/";
        // Append city parameter if provided
        if (city) {
          url += `?city=${encodeURIComponent(city)}`;
        }

        console.log("Fetching agricultural alerts from:", url);
        const response = await fetch(url);

        if (!response.ok) {
          const errorText = await response.text();
          console.error("Server response:", response.status, errorText);
          throw new Error(
            `HTTP error ${response.status}: ${errorText || "Unknown error"}`
          );
        }

        const data = await response.json();

        // Debug log the data
        console.log("Agricultural Alerts Data:", data);

        // Create the structured data the UI expects
        const structuredData = {
          location: data.location || { city: city || "Auto-detected" },
          weather: data.weather || {
            temp: 25,
            date: new Date().toLocaleDateString(),
          },
          pest_alerts: [],
          weather_alerts: [],
          plant_alerts: [],
        };

        // Process alerts by type (if alerts exist in the response)
        const alerts = data.alerts || data;
        if (Array.isArray(alerts)) {
          alerts.forEach((alert) => {
            if (alert.alert_type === "weather") {
              structuredData.weather_alerts.push(alert);
            } else if (alert.alert_type === "pest") {
              structuredData.pest_alerts.push(alert);
            } else if (alert.alert_type === "plant") {
              structuredData.plant_alerts.push(alert);
            }
          });
        }

        console.log("Structured alerts data:", structuredData);

        // Warning in console if no weather alerts found
        if (structuredData.weather_alerts.length === 0) {
          console.warn("Warning: No weather alerts data returned from API");
        }

        // Add indicator if there are no alerts at all
        structuredData.hasAlerts =
          structuredData.weather_alerts.length > 0 ||
          structuredData.pest_alerts.length > 0 ||
          structuredData.plant_alerts.length > 0;

        return structuredData;
      } catch (error) {
        console.error("Failed to fetch agricultural alerts:", error);
        throw new Error(`Error: ${error.message}`);
      }
    };

    // Function to create alert UI
    window.createAlertsUI = function (alertsData) {
      if (!alertsData) return null;

      const alertsContainer = document.createElement("div");
      alertsContainer.className = "agri-alerts-container";

      // Add location selector
      const locationSelector = document.createElement("div");
      locationSelector.className = "location-selector";

      const locationLabel = document.createElement("label");
      locationLabel.textContent = "Select Location:";
      locationLabel.htmlFor = "citySelector";

      const citySelect = document.createElement("select");
      citySelect.id = "citySelector";

      // Add the "Auto-detect" option
      const autoDetectOption = document.createElement("option");
      autoDetectOption.value = "";
      autoDetectOption.textContent = "Auto-detect";
      citySelect.appendChild(autoDetectOption);

      // Add the "National" option
      const nationalOption = document.createElement("option");
      nationalOption.value = "national";
      nationalOption.textContent = "National (Country-wide)";
      citySelect.appendChild(nationalOption);

      // Add the "All Lebanon" option
      const allLebanonOption = document.createElement("option");
      allLebanonOption.value = "all_lebanon";
      allLebanonOption.textContent = "All Lebanon (Multiple Regions)";
      citySelect.appendChild(allLebanonOption);

      // Add all Lebanese cities
      window.lebaneseCities.forEach((city) => {
        const option = document.createElement("option");
        option.value = city;
        option.textContent = city;
        // Set current city as selected if it matches
        if (alertsData.location && alertsData.location.city === city) {
          option.selected = true;
        }
        citySelect.appendChild(option);
      });

      // Add change handler for city selection
      citySelect.addEventListener("change", async () => {
        const selectedCity = citySelect.value;

        // Show loading state in modal body
        const modalBody = document.querySelector(".alerts-modal-body");
        if (modalBody) {
          modalBody.innerHTML =
            '<div class="alerts-loading"><i class="fas fa-spinner fa-spin"></i> Loading alerts for ' +
            (selectedCity || "your area") +
            "...</div>";
        }

        // Fetch new alerts for selected city
        const newAlertsData = await window.fetchAgriculturalAlerts(
          selectedCity
        );

        // Update the UI with new alerts
        if (newAlertsData && modalBody) {
          const newAlertsUI = window.createAlertsUI(newAlertsData);
          if (newAlertsUI) {
            modalBody.innerHTML = "";
            modalBody.appendChild(newAlertsUI);
          } else {
            modalBody.innerHTML =
              '<div class="alerts-error">No alerts available for ' +
              (selectedCity || "your area") +
              ".</div>";
          }
        }
      });

      locationSelector.appendChild(locationLabel);
      locationSelector.appendChild(citySelect);
      alertsContainer.appendChild(locationSelector);

      // Add location and weather info
      if (alertsData.location && alertsData.weather) {
        const locationHeader = document.createElement("div");
        locationHeader.className = "alerts-location-header";

        const locationCity = alertsData.location.city || "Unknown Location";
        const weatherTemp = alertsData.weather.temp
          ? `${alertsData.weather.temp}Â°C`
          : "N/A";
        const weatherDate = alertsData.weather.date || "Today";

        locationHeader.innerHTML = `
                <h3><i class="fas fa-map-marker-alt"></i> ${locationCity}</h3>
                <div class="weather-info">
                    <span><i class="fas fa-thermometer-half"></i> ${weatherTemp}</span>
                    <span><i class="fas fa-calendar-day"></i> ${weatherDate}</span>
                </div>
            `;

        alertsContainer.appendChild(locationHeader);
      }

      // Check if there are no alerts at all
      if (!alertsData.hasAlerts) {
        const noAlertsMessage = document.createElement("div");
        noAlertsMessage.className = "no-alerts-message";
        noAlertsMessage.innerHTML = `
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <p>Good news! There are no agricultural alerts for ${
              alertsData.location.city || "your area"
            } today.</p>
            <p>This means current conditions are favorable for most agricultural activities.</p>
          </div>
        `;
        alertsContainer.appendChild(noAlertsMessage);
      }

      // Plant care alerts
      if (alertsData.plant_alerts && alertsData.plant_alerts.length > 0) {
        const plantAlertsSection = document.createElement("div");
        plantAlertsSection.className = "alerts-section plant-alerts";

        const sectionHeader = document.createElement("h4");
        sectionHeader.innerHTML =
          '<i class="fas fa-leaf"></i> Plant Care Recommendations';
        plantAlertsSection.appendChild(sectionHeader);

        const alertsList = document.createElement("ul");
        alertsData.plant_alerts.forEach((alert) => {
          const alertItem = document.createElement("li");
          alertItem.className = `alert-item ${alert.type}`;
          alertItem.textContent = alert.message;
          alertsList.appendChild(alertItem);
        });

        plantAlertsSection.appendChild(alertsList);
        alertsContainer.appendChild(plantAlertsSection);
      }

      // Pest and disease alerts
      if (alertsData.pest_alerts && alertsData.pest_alerts.length > 0) {
        const pestAlertsSection = document.createElement("div");
        pestAlertsSection.className = "alerts-section pest-alerts";

        const sectionHeader = document.createElement("h4");
        sectionHeader.innerHTML =
          '<i class="fas fa-bug"></i> Pest & Disease Alerts';
        pestAlertsSection.appendChild(sectionHeader);

        // Create separate containers for high, medium and safe risk levels
        const highRiskContainer = document.createElement("div");
        highRiskContainer.className = "risk-container high-risk";
        const highRiskHeader = document.createElement("h5");
        highRiskHeader.className = "risk-header high-risk";
        highRiskHeader.innerHTML =
          '<i class="fas fa-exclamation-triangle"></i> High Risk Alerts';
        highRiskContainer.appendChild(highRiskHeader);

        const mediumRiskContainer = document.createElement("div");
        mediumRiskContainer.className = "risk-container medium-risk";
        const mediumRiskHeader = document.createElement("h5");
        mediumRiskHeader.className = "risk-header medium-risk";
        mediumRiskHeader.innerHTML =
          '<i class="fas fa-exclamation-circle"></i> Medium Risk Alerts';
        mediumRiskContainer.appendChild(mediumRiskHeader);

        const safeContainer = document.createElement("div");
        safeContainer.className = "risk-container safe";
        const safeHeader = document.createElement("h5");
        safeHeader.className = "risk-header safe";
        safeHeader.innerHTML =
          '<i class="fas fa-check-circle"></i> Safe/Beneficial Updates';
        safeContainer.appendChild(safeHeader);

        // Track if we have items in each category
        let hasHighRisk = false;
        let hasMediumRisk = false;
        let hasSafe = false;

        alertsData.pest_alerts.forEach((alert) => {
          const alertItem = document.createElement("li");
          alertItem.className = `alert-item pest ${
            alert.risk_level || "unknown"
          }-risk`;

          // Debug logging for each alert
          console.log(`Rendering alert: ${alert.title}`);
          console.log(`Alert location: ${alert.location}`);

          const alertTitle = document.createElement("h5");
          alertTitle.className = "alert-title";

          // Add location to title if available
          if (alert.location) {
            console.log(`Adding location to title: ${alert.location}`);
            alertTitle.innerHTML = `${alert.title} <span class="alert-location">(${alert.location})</span>`;
          } else {
            console.log("No location available for this alert");
            alertTitle.textContent = alert.title;
          }

          const alertDescription = document.createElement("p");
          alertDescription.className = "alert-description";
          // Limit description length
          const maxLength = 150;
          alertDescription.textContent =
            alert.description.length > maxLength
              ? alert.description.substring(0, maxLength) + "..."
              : alert.description;

          // Create risk analysis element
          const riskAnalysis = document.createElement("p");
          riskAnalysis.className = "risk-analysis";
          riskAnalysis.textContent = alert.risk_analysis || "";

          // Create source element
          const sourceElement = document.createElement("p");
          sourceElement.className = "alert-source";
          sourceElement.innerHTML = `<strong>Source:</strong> ${
            alert.source || "Unknown"
          }`;

          const alertLink = document.createElement("a");
          alertLink.href = alert.link;
          alertLink.target = "_blank";
          alertLink.className = "alert-link";
          alertLink.textContent = "Read full article";

          alertItem.appendChild(alertTitle);
          alertItem.appendChild(alertDescription);
          if (alert.risk_analysis) {
            alertItem.appendChild(riskAnalysis);
          }
          alertItem.appendChild(sourceElement);
          alertItem.appendChild(alertLink);

          // Add to the appropriate risk container
          if (alert.risk_level === "high") {
            if (!highRiskContainer.querySelector("ul")) {
              const ul = document.createElement("ul");
              highRiskContainer.appendChild(ul);
            }
            highRiskContainer.querySelector("ul").appendChild(alertItem);
            hasHighRisk = true;
          } else if (alert.risk_level === "medium") {
            if (!mediumRiskContainer.querySelector("ul")) {
              const ul = document.createElement("ul");
              mediumRiskContainer.appendChild(ul);
            }
            mediumRiskContainer.querySelector("ul").appendChild(alertItem);
            hasMediumRisk = true;
          } else {
            if (!safeContainer.querySelector("ul")) {
              const ul = document.createElement("ul");
              safeContainer.appendChild(ul);
            }
            safeContainer.querySelector("ul").appendChild(alertItem);
            hasSafe = true;
          }
        });

        // Only add containers that have items
        if (hasHighRisk) {
          pestAlertsSection.appendChild(highRiskContainer);
        }
        if (hasMediumRisk) {
          pestAlertsSection.appendChild(mediumRiskContainer);
        }
        if (hasSafe) {
          pestAlertsSection.appendChild(safeContainer);
        }

        alertsContainer.appendChild(pestAlertsSection);
      } else {
        // Create a section for pest alerts with no alerts message
        const pestAlertsSection = document.createElement("div");
        pestAlertsSection.className = "alerts-section pest-alerts";

        const sectionHeader = document.createElement("h4");
        sectionHeader.innerHTML =
          '<i class="fas fa-bug"></i> Pest & Disease Alerts';
        pestAlertsSection.appendChild(sectionHeader);

        const noAlertsMessage = document.createElement("div");
        noAlertsMessage.className = "no-alerts-message";
        noAlertsMessage.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <p>No pest or disease alerts for ${
              alertsData.location.city || "your area"
            } today.</p>
          </div>
        `;
        pestAlertsSection.appendChild(noAlertsMessage);
        alertsContainer.appendChild(pestAlertsSection);
      }

      // Weather alerts
      if (alertsData.weather_alerts && alertsData.weather_alerts.length > 0) {
        const weatherAlertsSection = document.createElement("div");
        weatherAlertsSection.className = "alerts-section weather-alerts";

        const sectionHeader = document.createElement("h4");
        sectionHeader.innerHTML =
          '<i class="fas fa-cloud-sun-rain"></i> Weather Alerts';
        weatherAlertsSection.appendChild(sectionHeader);

        // Create separate containers for high, medium and safe risk levels
        const highRiskContainer = document.createElement("div");
        highRiskContainer.className = "risk-container high-risk";
        const highRiskHeader = document.createElement("h5");
        highRiskHeader.className = "risk-header high-risk";
        highRiskHeader.innerHTML =
          '<i class="fas fa-exclamation-triangle"></i> High Risk Weather';
        highRiskContainer.appendChild(highRiskHeader);

        const mediumRiskContainer = document.createElement("div");
        mediumRiskContainer.className = "risk-container medium-risk";
        const mediumRiskHeader = document.createElement("h5");
        mediumRiskHeader.className = "risk-header medium-risk";
        mediumRiskHeader.innerHTML =
          '<i class="fas fa-exclamation-circle"></i> Medium Risk Weather';
        mediumRiskContainer.appendChild(mediumRiskHeader);

        const safeContainer = document.createElement("div");
        safeContainer.className = "risk-container safe";
        const safeHeader = document.createElement("h5");
        safeHeader.className = "risk-header safe";
        safeHeader.innerHTML =
          '<i class="fas fa-check-circle"></i> Favorable Weather';
        safeContainer.appendChild(safeHeader);

        // Track if we have items in each category
        let hasHighRisk = false;
        let hasMediumRisk = false;
        let hasSafe = false;

        alertsData.weather_alerts.forEach((alert) => {
          const alertItem = document.createElement("li");
          alertItem.className = `alert-item weather ${
            alert.risk_level || "unknown"
          }-risk`;

          const alertContent = document.createElement("div");
          alertContent.className = "alert-content";

          const alertIcon = document.createElement("i");

          if (alert.type === "drought") {
            alertIcon.className = "fas fa-tint-slash";
          } else if (alert.type === "frost") {
            alertIcon.className = "fas fa-snowflake";
          } else if (alert.type === "heatwave") {
            alertIcon.className = "fas fa-temperature-high";
          } else {
            alertIcon.className = "fas fa-cloud";
          }

          alertItem.appendChild(alertIcon);

          // Debug logging for weather alert
          console.log(`Rendering weather alert: ${alert.title}`);
          console.log(`Weather alert location: ${alert.location}`);

          const alertTitle = document.createElement("h5");
          // Add location to title if available
          if (alert.location) {
            console.log(`Adding weather location to title: ${alert.location}`);
            alertTitle.innerHTML = `${alert.title} <span class="alert-location">(${alert.location})</span>`;
          } else {
            console.log("No location available for this weather alert");
            alertTitle.textContent = alert.title;
          }
          alertContent.appendChild(alertTitle);

          const alertMessage = document.createElement("p");
          alertMessage.textContent = alert.description;
          alertContent.appendChild(alertMessage);

          // Add risk analysis
          if (alert.risk_analysis) {
            const riskAnalysis = document.createElement("p");
            riskAnalysis.className = "risk-analysis";
            riskAnalysis.textContent = alert.risk_analysis;
            alertContent.appendChild(riskAnalysis);
          }

          // Add source
          const sourceElement = document.createElement("p");
          sourceElement.className = "alert-source";
          sourceElement.innerHTML = `<strong>Source:</strong> ${
            alert.source || "Unknown"
          }`;
          alertContent.appendChild(sourceElement);

          // Add read more link
          if (alert.link) {
            const alertLink = document.createElement("a");
            alertLink.href = alert.link;
            alertLink.className = "alert-link";
            alertLink.target = "_blank";
            alertLink.textContent = "Read more";
            alertContent.appendChild(alertLink);
          }

          alertItem.appendChild(alertContent);

          // Add to the appropriate risk container
          if (alert.risk_level === "high") {
            if (!highRiskContainer.querySelector("ul")) {
              const ul = document.createElement("ul");
              highRiskContainer.appendChild(ul);
            }
            highRiskContainer.querySelector("ul").appendChild(alertItem);
            hasHighRisk = true;
          } else if (alert.risk_level === "medium") {
            if (!mediumRiskContainer.querySelector("ul")) {
              const ul = document.createElement("ul");
              mediumRiskContainer.appendChild(ul);
            }
            mediumRiskContainer.querySelector("ul").appendChild(alertItem);
            hasMediumRisk = true;
          } else {
            if (!safeContainer.querySelector("ul")) {
              const ul = document.createElement("ul");
              safeContainer.appendChild(ul);
            }
            safeContainer.querySelector("ul").appendChild(alertItem);
            hasSafe = true;
          }
        });

        // Only add containers that have items
        if (hasHighRisk) {
          weatherAlertsSection.appendChild(highRiskContainer);
        }
        if (hasMediumRisk) {
          weatherAlertsSection.appendChild(mediumRiskContainer);
        }
        if (hasSafe) {
          weatherAlertsSection.appendChild(safeContainer);
        }

        alertsContainer.appendChild(weatherAlertsSection);
      }

      // Add footer with refresh button and dismiss option
      const alertsFooter = document.createElement("div");
      alertsFooter.className = "alerts-footer";

      const refreshButton = document.createElement("button");
      refreshButton.className = "refresh-alerts-btn";
      refreshButton.innerHTML =
        '<i class="fas fa-sync-alt"></i> Refresh Alerts';
      refreshButton.onclick = showAgriculturalAlerts;

      const dismissButton = document.createElement("button");
      dismissButton.className = "dismiss-alerts-btn";
      dismissButton.innerHTML = "Dismiss for today";
      dismissButton.onclick = dismissAlertsForToday;

      alertsFooter.appendChild(refreshButton);
      alertsFooter.appendChild(dismissButton);
      alertsContainer.appendChild(alertsFooter);

      return alertsContainer;
    };

    // Function to show agricultural alerts in a modal
    window.showAgriculturalAlerts = async function (city = null) {
      // Create modal container if it doesn't exist
      let alertsModal = document.getElementById("agriAlertsModal");

      if (!alertsModal) {
        alertsModal = document.createElement("div");
        alertsModal.id = "agriAlertsModal";
        alertsModal.className = "agri-alerts-modal";

        // Add close button
        const closeBtn = document.createElement("span");
        closeBtn.className = "alerts-close-btn";
        closeBtn.innerHTML = "&times;";
        closeBtn.onclick = closeAlertsModal;

        // Add modal content container
        const modalContent = document.createElement("div");
        modalContent.className = "alerts-modal-content";

        // Add header
        const modalHeader = document.createElement("div");
        modalHeader.className = "alerts-modal-header";

        const modalTitle = document.createElement("h2");
        modalTitle.textContent = "Agricultural Alerts";

        modalHeader.appendChild(modalTitle);
        modalHeader.appendChild(closeBtn);

        // Add modal body for alerts content
        const modalBody = document.createElement("div");
        modalBody.className = "alerts-modal-body";
        modalBody.innerHTML =
          '<div class="alerts-loading"><i class="fas fa-spinner fa-spin"></i> Loading alerts...</div>';

        modalContent.appendChild(modalHeader);
        modalContent.appendChild(modalBody);
        alertsModal.appendChild(modalContent);

        document.body.appendChild(alertsModal);
      } else {
        // Just update the body content if modal already exists
        const modalBody = alertsModal.querySelector(".alerts-modal-body");
        modalBody.innerHTML =
          '<div class="alerts-loading"><i class="fas fa-spinner fa-spin"></i> Loading alerts...</div>';
        alertsModal.style.display = "block";
      }

      // Get city preference from localStorage or use the provided city
      const preferredCity = city || localStorage.getItem("agrAlertsCity");

      // Fetch alerts data
      try {
        const alertsData = await window.fetchAgriculturalAlerts(preferredCity);
        const modalBody = alertsModal.querySelector(".alerts-modal-body");

        if (alertsData) {
          const alertsUI = window.createAlertsUI(alertsData);
          if (alertsUI) {
            modalBody.innerHTML = "";
            modalBody.appendChild(alertsUI);
          } else {
            modalBody.innerHTML =
              '<div class="alerts-error">No alerts available at this time.</div>';
          }
        } else {
          modalBody.innerHTML =
            '<div class="alerts-error">Failed to load agricultural alerts. Please try again later.</div>';
        }
      } catch (error) {
        console.error("Error in showAgriculturalAlerts:", error);
        const modalBody = alertsModal.querySelector(".alerts-modal-body");
        modalBody.innerHTML = `<div class="alerts-error">Error: ${error.message}<br>Please check the console for details and try again later.</div>`;
      }
    };

    // Function to close the alerts modal
    window.closeAlertsModal = function () {
      const alertsModal = document.getElementById("agriAlertsModal");
      if (alertsModal) {
        alertsModal.style.display = "none";
      }
    };

    // Function to dismiss alerts for today
    window.dismissAlertsForToday = function () {
      // Save the current date to localStorage to prevent showing alerts again today
      localStorage.setItem("agriAlertsLastShown", new Date().toDateString());

      // Close the modal
      window.closeAlertsModal();
    };

    // Function to check if alerts should be shown today
    window.shouldShowAlerts = function () {
      const lastShown = localStorage.getItem("agriAlertsLastShown");
      const today = new Date().toDateString();

      return lastShown !== today;
    };
  }

  // Initialize the alerts functionality
  document.addEventListener("DOMContentLoaded", function () {
    // Only initialize if we haven't already
    if (!window.agricAlertsInitialized) {
      // Check if user is on the landowner page
      const isLandownerPage = window.location.pathname.includes("/landowner");

      // Check user role - to ensure only landowners can see this
      // This is determined by the presence of landowner-specific elements or by checking a data attribute
      const isLandowner =
        document.body.classList.contains("landowner-user") ||
        document.querySelector('[data-user-role="landowner"]') !== null ||
        document.body.getAttribute("data-user-role") === "landowner";

      // If we're on a page that should show agricultural alerts
      if (isLandownerPage || isLandowner) {
        // Find alert buttons and add click handlers
        const alertButtons = document.querySelectorAll(".agri-alerts-btn");

        alertButtons.forEach((btn) => {
          btn.addEventListener("click", function () {
            // Check if we have a city selector in the profile page
            const citySelector = document.getElementById("agri-alerts-city");
            let selectedCity = null;

            if (citySelector) {
              selectedCity = citySelector.value;
              console.log("Selected city from dropdown:", selectedCity);
            }

            // Show alerts with the selected city
            window.showAgriculturalAlerts(selectedCity);
          });
        });

        // Add change handler for city selector if it exists (in profile page)
        const citySelector = document.getElementById("agri-alerts-city");
        if (citySelector) {
          citySelector.addEventListener("change", function () {
            console.log("City selection changed to:", citySelector.value);
            // Don't automatically show alerts, just wait for the button click
          });
        }

        // Mark as initialized
        window.agricAlertsInitialized = true;
      }
    }
  });
})();
